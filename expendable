-* SET SUMMARY=EXPLICIT allows to do each field separately.
-* SET SUMMARY=EXPLICIT


-* Calcule du nombre de RUPTURE
ENGINE SQLPSTGR SET DEFAULT_CONNECTION CON01
SQL SQLPSTGR PREPARE SQLOUT FOR
 SELECT
 	"ZONE_COMMERCIALE",
 	"DATE_JOUR",
 	"MSISDN",
 	COUNT("MSISDN") as "NBR_HEURES",
	COUNT(1) FILTER (where "ETAT_FIXE" like 'RUPTURE') AS "PDV_EN_RUPTURE",
	COUNT(1) FILTER (where "ETAT_FIXE" like 'SEUIL') AS "PDV_EN_SEUIL",
	COUNT(1) FILTER (where "ETAT_FIXE" like 'TRAFFIC') AS "PDV_EN_TRAFFIC"
 FROM PUBLIC.suivi_stock_novembre_20221106
 GROUP BY "MSISDN" , "DATE_JOUR", "ZONE_COMMERCIALE";
END

DEFINE FILE SQLOUT
    TAUX_RUPTURE= PDV_EN_RUPTURE / (PDV_EN_RUPTURE + PDV_EN_SEUIL + PDV_EN_TRAFFIC);

END

TABLE FILE SQLOUT
PRINT * TAUX_RUPTURE
-* SUM AVE.TAUX_RUPTURE
-* BY DATE_JOUR
BY ZONE_COMMERCIALE
ON TABLE SET EXPANDBYROW ON
ON TABLE SET SQUEEZE ON
ON TABLE SET STYLE *
TYPE=REPORT,COLOR=NAVY,SQUEEZE=ON,FONT='ARIAL',SIZE=9,GRID=OFF,$
TYPE=HEADING,LINe=1,STYLE=BOLD,SIZE=12,JUSTIFY=CENTER,$
TYPE=TITLE,BACKCOLOR=RGB(45 111 205),COLOR=WHITE,STYLE=-UNDERLINE+BOLD, $
TYPE=DATA,BACKCOLOR=(WHITE RGB(235 235 255)),$
TYPE=SUBTOTAL,BACKCOLOR=RGB(163 200 236),STYLE=BOLD,$
END
END


-* GRAPH FILE SQLOUT
-* SUM TAUX_RUPTURE AS 'TAUX CONSTANTE'
-* BY DATE_JOUR
-* -* WHERE_GROUPED MSISDN EQ 708970129
-* ON GRAPH PCHOLD FORMAT JSCHART
-* ON GRAPH SET LOOKGRAPH EXTENSION
-* ON GRAPH SET AUTOFIT ON
-* ON GRAPH SET STYLE *
-* TYPE=DATA, COLUMN=N2, BUCKET= >value, $
-* *GRAPH_JS_FINAL
-* "chartType": "com.ibi.kpibox2",
-* "extensions": {
-*     "com.ibi.kpibox2": {
-*       "value": 3,
-*       "kpiboxProperties": { 
-*             "calculateFontSize": false,
-*             "textAlign":true,
-*         }
-*     }
-* }
-* *END
-* ENDSTYLE
-* END
